// ==UserScript==
// @name       changjiang-ai-answer
// @namespace  wibus/changjiang-ai-answer
// @version    0.0.0
// @icon       https://vitejs.dev/logo.svg
// @match      https://changjiang.yuketang.cn/*
// @match      https://changjiang-exam.yuketang.cn/*
// @match      https://www.doubao.com/*
// @grant      GM_addStyle
// @grant      GM_info
// @grant      unsafeWindow
// ==/UserScript==

(function () {
  'use strict';

  const d=new Set;const Pt = async e=>{d.has(e)||(d.add(e),(t=>{typeof GM_addStyle=="function"?GM_addStyle(t):document.head.appendChild(document.createElement("style")).append(t);})(e));};

  const $t=':root{--cjai-bg: rgba(255, 255, 255, .8);--cjai-bg-muted: rgba(255, 255, 255, .9);--cjai-border: rgba(0, 0, 0, .1);--cjai-ink: #111;--cjai-ink-muted: #666;--cjai-shadow: 0 8px 30px rgba(0, 0, 0, .12);--cjai-radius: 12px;--cjai-accent: #111;--cjai-danger: #e11d48;--cjai-primary: #111}.cjai-panel{position:fixed;inset:auto auto 24px 24px;min-width:260px;min-height:120px;width:360px;height:240px;z-index:10;color:var(--cjai-ink);background:var(--cjai-bg);-webkit-backdrop-filter:saturate(180%) blur(12px);backdrop-filter:saturate(180%) blur(12px);border:1px solid var(--cjai-border);border-radius:var(--cjai-radius);box-shadow:var(--cjai-shadow);overflow:hidden;-webkit-user-select:none;user-select:none;font:13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}.cjai-panel *{box-sizing:border-box}.cjai-panel__header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--cjai-border);cursor:move;background:var(--cjai-bg-muted)}.cjai-panel__title{font-weight:600;letter-spacing:.2px}.cjai-panel__controls{display:flex;gap:6px}.cjai-btn{appearance:none;border:1px solid var(--cjai-border);background:transparent;color:var(--cjai-ink);padding:6px 10px;border-radius:8px;cursor:pointer;transition:all .12s ease}.cjai-btn:hover{border-color:var(--cjai-ink)}.cjai-btn--primary{background:var(--cjai-accent);color:#fff;border-color:transparent}.cjai-btn--primary:hover{filter:brightness(1.05)}.cjai-btn--danger{background:#e11d48;color:#fff;border-color:transparent}.cjai-btn--danger:hover{filter:brightness(1.05)}.cjai-btn[disabled]{opacity:.5;cursor:not-allowed}.cjai-chip{font-size:10px;padding:2px 6px;background:var(--cjai-bg-muted);border:1px solid var(--cjai-border);border-radius:999px;color:var(--cjai-ink-muted);margin-left:6px}.cjai-panel__body{display:flex;flex-direction:column;gap:8px;padding:8px;height:calc(100% - 40px)}.cjai-tabs{display:flex;gap:6px;padding:4px;border:1px solid var(--cjai-border);border-radius:8px;background:var(--cjai-bg-muted)}.cjai-tab{appearance:none;border:none;background:transparent;color:var(--cjai-ink-muted);padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600}.cjai-tab[aria-selected=true]{background:var(--cjai-bg);color:var(--cjai-ink);box-shadow:inset 0 0 0 1px var(--cjai-border)}.cjai-panel__content{position:relative;flex:1;min-height:0;border:1px solid var(--cjai-border);border-radius:8px;overflow:hidden;background:var(--cjai-bg)}.cjai-tabpane{position:absolute;inset:0;overflow:auto;display:none;background:#fff}.cjai-tabpane[data-active=true]{display:block}.cjai-controls{display:flex;flex-direction:column;gap:8px;height:100%}.cjai-controls__content{padding:8px 2px 8px 8px;flex:1;min-height:0;overflow:auto}.cjai-controls__actions{flex:0 0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px;border-top:1px solid var(--cjai-border);background:var(--cjai-bg-muted);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);position:sticky;bottom:0}.cjai-doc{white-space:pre-wrap;word-break:break-word;line-height:1.6}.cjai-section{border:1px solid var(--cjai-border);border-radius:8px;padding:10px;background:var(--cjai-bg)}.cjai-section+.cjai-section{margin-top:8px}.cjai-section__title{font-weight:600;margin-bottom:8px}.cjai-section__description{font-size:12px;color:var(--cjai-ink-muted);margin-bottom:8px}.cjai-rows{display:flex;flex-direction:column;gap:8px;margin-top:4px}.cjai-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 8px;border:1px solid var(--cjai-border);border-radius:8px;background:var(--cjai-bg)}.cjai-row__label{color:var(--cjai-ink);font-weight:500}.cjai-switch{position:relative;width:44px;height:24px}.cjai-switch input{opacity:0;width:0;height:0}.cjai-switch__slider{position:absolute;inset:0;background:#e5e7eb;border-radius:999px;transition:all .15s ease;box-shadow:inset 0 0 0 1px var(--cjai-border)}.cjai-switch__slider:after{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:all .15s ease;box-shadow:0 1px 2px #0000001a}.cjai-switch input:checked+.cjai-switch__slider{background:var(--cjai-accent);box-shadow:none}.cjai-switch input:checked+.cjai-switch__slider:after{transform:translate(20px)}.cjai-info-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.06)}.cjai-info-item:last-child{border-bottom:none}.cjai-info-key{color:var(--cjai-ink-muted)}.cjai-info-value{font-weight:600}.cjai-resize{position:absolute;right:6px;bottom:6px;width:14px;height:14px;cursor:nwse-resize;opacity:.6}.cjai-resize:after{content:"";position:absolute;right:2px;bottom:2px;width:10px;height:10px;border-right:2px solid var(--cjai-border);border-bottom:2px solid var(--cjai-border);border-radius:0 0 3px}.cjai-panel--collapsed{height:auto!important;width:auto!important;min-width:48px;min-height:32px}.cjai-panel--collapsed .cjai-panel__body,.cjai-panel--collapsed .cjai-resize{display:none}.cjai-panel--collapsed .cjai-panel__header{cursor:move;padding:6px 8px}.cjai-panel--collapsed .cjai-panel__title{font-size:12px}';Pt($t);const W={silent:0,error:1,warn:2,info:3,debug:4,trace:5},jt="CJ_AI_LOG_LEVEL",z="CJ-AI",qt=["background: linear-gradient(135deg, #2b6cb0, #3182ce)","color: #fff","padding: 2px 8px","border-radius: 999px 0 0 999px","font-weight: 700","font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto"].join(";"),Mt={error:["background: #c53030","color: #fff","padding: 2px 8px","border-radius: 0 999px 999px 0","font-weight: 700"].join(";"),warn:["background: #b7791f","color: #fff","padding: 2px 8px","border-radius: 0 999px 999px 0","font-weight: 700"].join(";"),info:["background: #2c5282","color: #fff","padding: 2px 8px","border-radius: 0 999px 999px 0","font-weight: 700"].join(";"),debug:["background: #4a5568","color: #fff","padding: 2px 8px","border-radius: 0 999px 999px 0","font-weight: 700"].join(";"),trace:["background: #1a202c","color: #fff","padding: 2px 8px","border-radius: 0 999px 999px 0","font-weight: 700"].join(";"),success:["background: #2f855a","color: #fff","padding: 2px 8px","border-radius: 0 999px 999px 0","font-weight: 700"].join(";")};function zt(){const n=typeof localStorage<"u"&&localStorage.getItem(jt)||"";return n&&n in W?n:"debug"}function Bt(n){try{typeof localStorage<"u"&&localStorage.setItem(jt,n);}catch{}}function L(n,t){const e=t?`:${t}`:"";return [`%c ${z}${e} %c ${n.toUpperCase()} `,qt,Mt[n],""]}function T(n,t){return W[n]>=W[t]}function At(n){let t=zt();const e=(r,s)=>(...i)=>{if(!T(t,r))return;const[a,c,d,u]=L(s==="success"?"success":r,n),l=console;switch(s){case "error":l.error(a,c,d,u,...i);break;case "warn":l.warn(a,c,d,u,...i);break;case "debug":l.debug(a,c,d,u,...i);break;case "trace":l.trace(a,c,d,u,...i);break;case "success":l.log(a,c,d,u,...i);break;default:l.log(a,c,d,u,...i);}};return {level:()=>t,setLevel:r=>{t=r,Bt(r);},error:e("error","error"),warn:e("warn","warn"),info:e("info","log"),debug:e("debug","debug"),trace:e("trace","trace"),success:e("info","success"),group:r=>{if(!T(t,"info"))return;const[s,i,a,c]=L("info",n);r?console.group(s+" %c"+r,i,a,c,""):console.group(s,i,a,c);},groupCollapsed:r=>{if(!T(t,"info"))return;const[s,i,a,c]=L("info",n);r?console.groupCollapsed(s+" %c"+r,i,a,c,""):console.groupCollapsed(s,i,a,c);},groupEnd:()=>{console.groupEnd();},time:(r="time")=>{T(t,"debug")&&console.time(`${z}${n?":"+n:""}:${r}`);},timeEnd:(r="time")=>{T(t,"debug")&&console.timeEnd(`${z}${n?":"+n:""}:${r}`);},table:(r,s)=>{if(!T(t,"debug"))return;const[i,a,c,d]=L("debug",n);typeof console.table=="function"?(console.log(i,a,c,d),console.table(r,s)):console.log(i,a,c,d,r);},assert:(r,...s)=>{if(!T(t,"warn"))return;const[i,a,c,d]=L("warn",n);console.assert(r??false,i,a,c,d,...s);},banner:(r,s)=>{if(!T(t,"info"))return;const i="background:#2b6cb0;color:white;padding:2px 8px;border-radius:8px 0 0 8px;font-weight:700;",a="background:#1a202c;color:#fff;padding:2px 8px;border-radius:0 8px 8px 0;font-weight:600;",c=`%c ${z} %c ${r}${s?" — "+s:""}`;console.log(c,i,a);},withScope:r=>At(n?`${n}:${r}`:r)}}const h=At(),Ft=".exam-aside .el-scrollbar__view .aside-body",Ht=".exam-aside",Nt=".subject-item.J_order[data-order]",Wt=".subject-item.J_order.active",Ut=".aside-body--progress";function _(){return document.querySelector(Ft)||document.querySelector(Ht)}function B(n){const t=n??_();return t?Array.from(t.querySelectorAll(Nt)):[]}function Zt(n){if(!n)return null;const t=n.getAttribute("data-order")||"",e=parseInt(t,10);if(!Number.isNaN(e))return e;const r=(n.textContent||"").trim().match(/\d+/);return r?parseInt(r[0],10):null}function it(n){const t=n??_();return t?t.querySelector(Wt):null}function Vt(n){const t=_();if(!t)return null;const e=t.querySelector(Ut);if(!e)return null;const r=(e.textContent||"").replace(/\u00A0/g," ").trim().match(/\/(\s*\d+)\s*题?/);if(r){const s=parseInt(r[1].trim(),10);if(!Number.isNaN(s))return s}return null}function Gt(n,t=true){try{n.scrollIntoView({block:"center",behavior:t?"smooth":"auto"});}catch{n.scrollIntoView();}}function Kt(n,t){const e=_();if(!e)return  false;const o=e.querySelector(`${Nt}[data-order="${n}"]`);return o?(Gt(o,t?.smooth!==false),o.click(),h.info("goTo",n),true):false}async function Qt(n={}){const{timeoutMs:t=1e4,intervalMs:e=300,useObserver:o=true,signal:r}=n,s=_();if(s&&B(s).length>0)return s;let i=false,a=null,c=null,d=null;const u=(l,f)=>{i||(i=true,a!==null&&window.clearInterval(a),c!==null&&window.clearTimeout(c),d&&d.disconnect(),f(l));};return new Promise(l=>{const f=()=>{const p=_();p&&B(p).length>0&&u(p,l);};if(a=window.setInterval(f,e),o&&typeof MutationObserver<"u"){const p=document.body;d=new MutationObserver(()=>f()),d.observe(p,{childList:true,subtree:true});}if(c=window.setTimeout(()=>u(null,l),t),r){const p=()=>u(null,l);r.addEventListener("abort",p,{once:true});}})}const x={container:_,list:()=>B(),currentEl:it,current:()=>Zt(it()),total:()=>Vt()??(B().length||null),goTo:Kt,next:n=>{const t=x.total(),e=x.current(),o=e?e+1:1;return t&&o>t?n?.loop?x.goTo(1,n):false:x.goTo(o,n)},prev:n=>{const t=x.total(),e=x.current(),o=e?e-1:1;return o<1?n?.loop&&t?x.goTo(t,n):false:x.goTo(o,n)},first:n=>x.goTo(1,n),last:n=>{const t=x.total();return t?x.goTo(t,n):false},wait:Qt},at="#app > div.viewContainer > div > div > div.container > div > div > div.container-problem > div.problem-fixedbar > div > div:nth-child(2) > div > ul > li > span > button",ct="#app > div.viewContainer > div > div > div.container > div > div > div.container-problem > div.el-scrollbar > div.el-scrollbar__wrap.el-scrollbar__wrap--hidden-default > div > div",Xt=[{domain:"main",hostMatch:n=>/(^|\.)changjiang\.yuketang\.cn$/.test(n),flags:{actionPanel:true,notepad:true,prompt:true,capture:true,orderNav:true,submitHotkey:true,questionExport:false,doubaoBridge:true},selectors:{submitButton:at,questionContainerExact:ct}},{domain:"doubao",hostMatch:n=>/(^|\.)doubao\.com$/.test(n),flags:{actionPanel:false,notepad:false,prompt:false,capture:false,orderNav:false,submitHotkey:false,questionExport:false,doubaoBridge:true}},{domain:"exam",hostMatch:n=>/(^|\.)changjiang-exam\.yuketang\.cn$/.test(n),flags:{actionPanel:true,notepad:true,prompt:true,capture:false,orderNav:false,submitHotkey:true,questionExport:true,doubaoBridge:false},selectors:{submitButton:at,questionContainerExact:ct}}];function Tt(n=location.hostname){return Xt.find(e=>e.hostMatch(n))||{domain:"unknown",hostMatch:()=>true,flags:{actionPanel:true,notepad:true,prompt:true,capture:false,orderNav:false,submitHotkey:false,questionExport:false,doubaoBridge:false}}}const Yt="CJ_AI_FLAGS_";function te(n){try{const t=`${Yt}${n.domain}`,e=localStorage.getItem(t);if(!e)return n;const o=JSON.parse(e);return {...n,...o,flags:{...n.flags,...o.flags||{}},selectors:{...n.selectors,...o.selectors||{}}}}catch{return n}}function P(n=location.hostname){return te(Tt(n))}function j(n){return !!P().flags[n]}function lt(){const n=P().selectors?.questionContainerExact||"#app > div.viewContainer > div > div > div.container > div > div > div.container-problem > div.el-scrollbar > div.el-scrollbar__wrap.el-scrollbar__wrap--hidden-default > div > div",t=/\(\s*\d+(?:\.\d+)?\s*分\s*\)/,e=/\b\d+[\.、]?[\u3001、\s]*[\u4e00-\u9fa5]{1,6}题\b/,o=p=>(p??"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim(),r=p=>{const b=o(p);return t.test(b)||e.test(b)},s=p=>{const b=p.getBoundingClientRect(),m=window.innerHeight||document.documentElement.clientHeight,E=window.innerWidth||document.documentElement.clientWidth,w=b.top<m&&b.bottom>0,y=b.left<E&&b.right>0;return w&&y},i=p=>{if(p.length===0)return null;const b=p.map(m=>({el:m,top:Math.abs(m.getBoundingClientRect().top)}));return b.sort((m,E)=>m.top-E.top),b[0].el},a=document.querySelector(".container-problem .el-scrollbar__view")||document.querySelector(".container-problem")||null,d=Array.from((a??document).querySelectorAll('.subject-item .item-type, .item-type, [class*="item-type"]')).filter(p=>r(p.textContent||"")).map(p=>p.closest(".subject-item")).filter(p=>!!p);if(d.length>0){const p=d.filter(s);return p.length>0?i(p):i(d)}const u=Array.from((a??document).querySelectorAll(".subject-item"));if(u.length>0){const p=u.filter(s);return p.length>0?i(p):u[0]??null}const l=document.querySelector(n);if(l)return l;const f=document.querySelector("#app .container-problem .el-scrollbar__wrap")||document.querySelector(".viewContainer .container-problem")||document.querySelector("#app");if(f){const b=Array.from(f.querySelectorAll(':scope > div, :scope > * > div, [class*="subject"], [class*="item"]')).filter(m=>m.childElementCount>0).filter(m=>m.getBoundingClientRect().height>40).filter(m=>/subject|item/i.test(m.className));if(b.length>0){const m=b.filter(s);return m.length>0?i(m):b[0]??null}}return null}async function _t(n={}){const{timeoutMs:t=1e4,intervalMs:e=300,useObserver:o=true,signal:r}=n,s=lt();if(s)return s;h.info("waitForQuestionElement: initial check did not find the element, start waiting...");let i=false,a=null,c=null,d=null;const u=(l,f)=>{i||(i=true,a!==null&&window.clearInterval(a),c!==null&&window.clearTimeout(c),d&&d.disconnect(),f(l));};return new Promise(l=>{const f=()=>{const p=lt();p&&u(p,l);};if(a=window.setInterval(f,e),o&&typeof MutationObserver<"u"){const p=document.querySelector(".container-problem .el-scrollbar__view")||document.querySelector(".container-problem")||document.body;d=new MutationObserver(()=>f()),d.observe(p,{childList:true,subtree:true});}if(c=window.setTimeout(()=>u(null,l),t),r){const p=()=>u(null,l);r.addEventListener("abort",p,{once:true});}})}let Ot=null;function ee(){return Ot}function Dt(n,t){return new Promise(e=>{if(document.getElementById(n)){e(true);return}const r=document.createElement("script");r.id=n,r.src=t,r.async=true,r.onload=()=>e(true),r.onerror=()=>e(false),document.head.appendChild(r);})}async function ne(){const n=globalThis;if(typeof window.html2canvas=="function")return  true;if(n&&typeof n.html2canvas=="function")return window.html2canvas=n.html2canvas,true;if(typeof unsafeWindow<"u"&&typeof unsafeWindow.html2canvas=="function")return window.html2canvas=unsafeWindow.html2canvas,true;await Dt("cjai-html2canvas","https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js")||h.warn("Failed to inject html2canvas from CDN");for(let e=0;e<50;e++){if(typeof window.html2canvas=="function")return  true;if(n&&typeof n.html2canvas=="function")return window.html2canvas=n.html2canvas,true;if(typeof unsafeWindow<"u"&&typeof unsafeWindow.html2canvas=="function")return window.html2canvas=unsafeWindow.html2canvas,true;await new Promise(o=>setTimeout(o,100));}return h.warn("html2canvas is not available"),false}async function oe(n,t={}){if(!await ne()||!window.html2canvas)return null;const o=t.scale??(window.devicePixelRatio||1),r=t.backgroundColor??"#fff";try{return await window.html2canvas(n,{backgroundColor:r,scale:o,useCORS:!0,logging:!1,allowTaint:!0,windowWidth:document.documentElement.clientWidth,windowHeight:document.documentElement.clientHeight})}catch(s){return Ot=s,h.error("captureElementToCanvas failed",s),null}}async function re(n,t={}){const e=await oe(n,t);return e?new Promise(o=>{e.toBlob(r=>o(r),"image/png");}):null}async function se(){const n=globalThis;if(window.JSZip)return  true;if(n&&n.JSZip)return window.JSZip=n.JSZip,true;if(typeof unsafeWindow<"u"&&unsafeWindow.JSZip)return window.JSZip=unsafeWindow.JSZip,true;await Dt("cjai-jszip","https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js")||h.warn("Failed to inject JSZip from CDN");for(let e=0;e<50;e++){if(window.JSZip)return  true;if(n&&n.JSZip)return window.JSZip=n.JSZip,true;if(typeof unsafeWindow<"u"&&unsafeWindow.JSZip)return window.JSZip=unsafeWindow.JSZip,true;await new Promise(o=>setTimeout(o,100));}return !!window.JSZip}async function ie(n,t="captures.zip"){if(!await se()||!window.JSZip)return  false;const o=new window.JSZip;for(const i of n)o.file(i.name,i.blob);const r=await o.generateAsync({type:"blob"}),s=URL.createObjectURL(r);try{const i=document.createElement("a");return i.href=s,i.download=t,document.body.appendChild(i),i.click(),i.remove(),!0}finally{setTimeout(()=>URL.revokeObjectURL(s),8e3);}}async function ae(n,t=150){for(const e of n){const o=URL.createObjectURL(e.blob),r=document.createElement("a");r.href=o,r.download=e.name,document.body.appendChild(r),r.click(),r.remove(),setTimeout(()=>URL.revokeObjectURL(o),8e3),t&&await new Promise(s=>setTimeout(s,t));}}async function ce(n){if(!("showDirectoryPicker"in window))return  false;try{const e=await window.showDirectoryPicker();for(const o of n){const s=await(await e.getFileHandle(o.name,{create:!0})).createWritable();await s.write(o.blob),await s.close();}return !0}catch{return  false}}function G(n){return new Promise(t=>setTimeout(t,n))}async function le(n,t={}){const{timeoutMs:e=1e4,intervalMs:o=100,signal:r}=t,s=Date.now();for(;;){if(r?.aborted)return  false;if(await n())return  true;if(Date.now()-s>e)return  false;await G(o);}}class de{constructor(t={}){this.options=t;}abort=new AbortController;running=false;stop(){this.running&&(this.abort.abort(),this.abort=new AbortController,this.running=false,h.warn("Capture stopped"));}async captureOne(t){if(!x.goTo(t,{smooth:false}))return h.warn("goTo failed",t),false;await le(()=>x.current()===t,{timeoutMs:8e3,intervalMs:100})||h.warn("Wait active timed out for order",t),(this.options.delayAfterNavigateMs??200)&&await G(this.options.delayAfterNavigateMs??200);const o=await _t({timeoutMs:12e3,intervalMs:250,signal:this.abort.signal});if(!o)return h.error("Question element not found for order",t),false;const r=x.total(),s=this.options.filenamePattern?this.options.filenamePattern(t,r):`question-${String(t).padStart(3,"0")}.png`;try{o.scrollIntoView({block:"nearest",behavior:"instant"});}catch{}const i=await re(o,this.options.screenshot);if(!i){const c=o.getBoundingClientRect(),d={reason:ee(),html2canvas:typeof window.html2canvas,rect:{x:Math.round(c.x),y:Math.round(c.y),w:Math.round(c.width),h:Math.round(c.height)},offset:{w:o.offsetWidth,h:o.offsetHeight},visibility:getComputedStyle(o).visibility,display:getComputedStyle(o).display,inDOM:document.contains(o)};return h.error("Capture failed for order",t,d),this.options.onCapture?.({order:t,total:r??null,filename:s,blob:null,url:null,status:"error",createdAt:Date.now(),selected:false,error:JSON.stringify(d)}),false}const a={order:t,total:r??null,filename:s,blob:i,url:null,status:"ok",createdAt:Date.now(),selected:true};return this.options.onCapture?.(a),h.success("Captured",s),true}async captureAllFromCurrent(){if(this.running){h.warn("Capture already running");return}this.running=true;try{await x.wait({timeoutMs:15e3,intervalMs:300,signal:this.abort.signal});const t=x.total(),e=x.current()??1;if(!t||t<=0){h.error("Total questions not detected");return}h.banner("Capture",`from ${e} to ${t}`);for(let o=e;o<=t&&!this.abort.signal.aborted;o++)await this.captureOne(o)||h.warn("Capture failed at order",o);h.success("Capture finished");}finally{this.running=false;}}}const ue={id:"cjai-action-panel",title:"Action Panel",dock:"bottom-right",resizable:true,draggable:true,collapsed:false,zIndex:999999,injectStyles:true},dt="cjai-action-panel-style";function pe(){let n=document.getElementById(dt);n||(n=document.createElement("style"),n.id=dt,document.head.appendChild(n)),n.textContent=`
  
  `;}function O(n,t,e){return Math.max(t,Math.min(e,n))}function ut(n){return `${n}:state`}class fe{root;header;titleEl;tabsBar;contentWrap;contentEl;actionsEl;resizeHandle;opts;unsub=[];dragging=false;dragOffset={x:0,y:0};resizing=false;resizeStart={w:0,h:0,x:0,y:0};panes=new Map;constructor(t={}){const e={...ue,...t};this.opts=e,e.injectStyles&&pe();const o=document.createElement("div");o.className="cjai-panel",o.style.zIndex=String(e.zIndex),o.style.position="fixed";const r=document.createElement("div");r.className="cjai-panel__header";const s=document.createElement("div");s.className="cjai-panel__title",s.textContent=e.title||"Action Panel";const i=document.createElement("div");i.className="cjai-panel__controls";const a=document.createElement("button");a.className="cjai-btn",a.title="Collapse / Expand",a.textContent="—";const c=document.createElement("button");c.className="cjai-btn",c.title="Close",c.textContent="×",i.append(a,c),r.append(s,i);const d=document.createElement("div");d.className="cjai-panel__body";const u=document.createElement("div");u.className="cjai-tabs";const l=document.createElement("div");l.className="cjai-panel__content";const f=document.createElement("div");f.className="cjai-tabpane cjai-controls",f.dataset.active="true";const p=document.createElement("div");p.className="cjai-controls__content";const b=document.createElement("div");b.className="cjai-controls__actions",f.append(p,b),l.append(f),d.append(u,l);const m=document.createElement("div");m.className="cjai-resize",o.append(r,d,m),this.root=o,this.header=r,this.titleEl=s,this.tabsBar=u,this.contentWrap=l,this.contentEl=p,this.actionsEl=b,this.resizeHandle=m,this.addTab({id:"controls",label:"Controls",content:f,select:true}),e.draggable&&this.enableDragging(),e.resizable&&this.enableResizing(),a.addEventListener("click",()=>this.setCollapsed(!this.isCollapsed())),c.addEventListener("click",()=>this.destroy()),this.restoreState(),t.position&&this.setPosition(t.position.x,t.position.y),t.size&&this.setSize(t.size.width,t.size.height),t.collapsed!=null&&this.setCollapsed(!!t.collapsed),(e.mount||document.body).appendChild(o);}saveState(){try{const t=this.root.getBoundingClientRect(),e={x:t.left,y:t.top,w:t.width,h:t.height,collapsed:this.isCollapsed()};localStorage.setItem(ut(this.opts.id),JSON.stringify(e));}catch{}}restoreState(){const t=ut(this.opts.id);let e=null;try{const d=localStorage.getItem(t);d&&(e=JSON.parse(d));}catch{}const o=window.innerWidth,r=window.innerHeight;let{x:s,y:i}=e??{x:NaN,y:NaN},{w:a,h:c}=e??{w:NaN,h:NaN};if((!Number.isFinite(a)||!Number.isFinite(c))&&(a=360,c=240),!Number.isFinite(s)||!Number.isFinite(i)){const u=this.opts.dock;s=u.includes("right")?o-a-24:24,i=u.includes("bottom")?r-c-24:24;}this.setSize(a,c),this.setPosition(s,i),(e?.collapsed??this.opts.collapsed)&&this.setCollapsed(true);}enableDragging(){const t=r=>{if(r.target?.closest(".cjai-panel__controls"))return;this.dragging=true;const s=this.root.getBoundingClientRect();this.dragOffset.x=r.clientX-s.left,this.dragOffset.y=r.clientY-s.top,this.root.style.transition="none",r.preventDefault();},e=r=>{if(!this.dragging)return;const s=window.innerWidth,i=window.innerHeight,a=this.root.getBoundingClientRect().width,c=this.root.getBoundingClientRect().height,d=O(r.clientX-this.dragOffset.x,0,s-a),u=O(r.clientY-this.dragOffset.y,0,i-c);this.root.style.left=`${d}px`,this.root.style.top=`${u}px`;},o=()=>{this.dragging&&(this.dragging=false,this.root.style.transition="",this.saveState());};this.header.addEventListener("mousedown",t),window.addEventListener("mousemove",e),window.addEventListener("mouseup",o),this.root.addEventListener("mousedown",r=>{this.isCollapsed()&&(r.target.closest(".cjai-panel__controls")||t(r));}),this.unsub.push(()=>{this.header.removeEventListener("mousedown",t),window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",o);});}enableResizing(){const t=this.resizeHandle,e=s=>{this.resizing=true;const i=this.root.getBoundingClientRect();this.resizeStart={w:i.width,h:i.height,x:s.clientX,y:s.clientY},this.root.style.transition="none",s.preventDefault();},o=s=>{if(!this.resizing)return;const i=s.clientX-this.resizeStart.x,a=s.clientY-this.resizeStart.y,c=O(this.resizeStart.w+i,240,Math.min(window.innerWidth-20,800)),d=O(this.resizeStart.h+a,120,Math.min(window.innerHeight-20,800));this.setSize(c,d);},r=()=>{this.resizing&&(this.resizing=false,this.root.style.transition="",this.saveState());};t.addEventListener("mousedown",e),window.addEventListener("mousemove",o),window.addEventListener("mouseup",r),this.unsub.push(()=>{t.removeEventListener("mousedown",e),window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",r);});}isCollapsed(){return this.root.classList.contains("cjai-panel--collapsed")}setCollapsed(t){this.root.classList.toggle("cjai-panel--collapsed",t),this.saveState();}setTitle(t){this.titleEl.textContent=t;}setPosition(t,e){const o=window.innerWidth,r=window.innerHeight,s=this.root.getBoundingClientRect(),i=s.width||360,a=s.height||240;this.root.style.left=`${O(t,0,o-i)}px`,this.root.style.top=`${O(e,0,r-a)}px`,this.root.style.right="auto",this.root.style.bottom="auto";}setSize(t,e){this.root.style.width=`${Math.max(240,t)}px`,this.root.style.height=`${Math.max(100,e)}px`;}mount(t){const e=t||this.opts.mount||document.body;this.root.parentElement||e.appendChild(this.root);}destroy(){this.unsub.forEach(t=>{try{t();}catch{}}),this.unsub=[],this.root.remove();}clearActions(){this.actionsEl.innerHTML="";}addAction(t){const e=document.createElement("button");if(e.className="cjai-btn"+(t.kind==="primary"?" cjai-btn--primary":t.kind==="danger"?" cjai-btn--danger":""),e.textContent=t.label,t.tooltip&&(e.title=t.tooltip),t.hotkey){const o=document.createElement("span");o.className="cjai-chip",o.textContent=t.hotkey,e.appendChild(o);}e.disabled=!!t.disabled,e.addEventListener("click",()=>t.onClick(this)),e.dataset.actionId=t.id,this.actionsEl.appendChild(e);}addTab({id:t,label:e,content:o,select:r=false}){if(this.panes.has(t))return this.panes.get(t);const s=document.createElement("button");s.className="cjai-tab",s.type="button",s.textContent=e,s.setAttribute("role","tab"),s.setAttribute("aria-controls",`pane-${t}`),s.setAttribute("aria-selected","false"),this.tabsBar.appendChild(s);const i=o??document.createElement("div");return o||(i.className="cjai-tabpane"),i.id=`pane-${t}`,i.dataset.active="false",this.contentWrap.appendChild(i),s.addEventListener("click",()=>this.selectTab(t)),this.panes.set(t,i),r&&this.selectTab(t),this.tabsBar.style.display=this.tabsBar.childElementCount>1?"flex":"none",i}selectTab(t){for(const e of Array.from(this.tabsBar.querySelectorAll(".cjai-tab"))){const o=e.getAttribute("aria-controls")===`pane-${t}`;e.setAttribute("aria-selected",String(o));}for(const[e,o]of this.panes.entries())o.dataset.active=String(e===t);}getTabPane(t){return this.panes.get(t)??null}updateAction(t,e){const o=this.actionsEl.querySelector(`button[data-action-id="${t}"]`);o&&(e.label!=null&&(o.firstChild?o.firstChild.textContent=e.label:o.textContent=e.label),e.tooltip!=null&&(o.title=e.tooltip||""),e.disabled!=null&&(o.disabled=!!e.disabled),e.kind&&(o.classList.remove("cjai-btn--primary","cjai-btn--danger"),e.kind==="primary"&&o.classList.add("cjai-btn--primary"),e.kind==="danger"&&o.classList.add("cjai-btn--danger")));}setDoc(t){if(this.contentEl.innerHTML="",typeof t=="string"){const e=document.createElement("div");e.className="cjai-doc",e.textContent=t,this.contentEl.appendChild(e);}else this.contentEl.appendChild(t);}setInfo(t){this.contentEl.innerHTML="";const e=Array.isArray(t)?t:Object.entries(t).map(([o,r])=>({key:o,label:o,value:r}));for(const o of e){const r=document.createElement("div");r.className="cjai-info-item";const s=document.createElement("div");s.className="cjai-info-key",s.textContent=o.label;const i=document.createElement("div");i.className="cjai-info-value",o.value instanceof HTMLElement?i.appendChild(o.value):i.textContent=String(o.value),o.tooltip&&(s.title=o.tooltip,i.title=o.tooltip),r.append(s,i),this.contentEl.appendChild(r);}}}class he{items=[];listeners=new Set;subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}emit(){for(const t of this.listeners)try{t();}catch{}}clear(){for(const t of this.items)t.url&&URL.revokeObjectURL(t.url);this.items=[],this.emit();}list(){return this.items.slice().sort((t,e)=>t.order-e.order)}get(t){return this.items.find(e=>e.order===t)}upsert(t){const e=this.items.findIndex(s=>s.order===t.order),o=e>=0?this.items[e]:{order:t.order,total:t.total??null,filename:t.filename||`question-${String(t.order).padStart(3,"0")}.png`,blob:null,url:null,status:t.status??"pending",createdAt:Date.now(),selected:true,error:void 0},r={...o,...t};r.blob&&r.blob!==o.blob&&(o.url&&URL.revokeObjectURL(o.url),r.url=URL.createObjectURL(r.blob)),e>=0?this.items[e]=r:this.items.push(r),this.emit();}setSelected(t,e){const o=this.get(t);o&&(o.selected=e,this.emit());}selectAll(t){for(const e of this.items)e.selected=t;this.emit();}toggle(t){const e=this.get(t);e&&(e.selected=!e.selected,this.emit());}selected(){return this.list().filter(t=>t.selected&&t.status==="ok"&&t.blob)}}class me{map=new Map;listeners=new Set;subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}emit(){for(const t of this.listeners)try{t();}catch{}}clear(){this.map.clear(),this.emit();}setAll(t){this.map.clear();for(const e of t)this.map.set(e.order,e);this.emit();}upsert(t){this.map.set(t.order,t),this.emit();}get(t){return this.map.get(t)||null}list(){return Array.from(this.map.values()).sort((t,e)=>t.order-e.order)}toJSON(){return {version:"1.0",answers:this.list().map(t=>({order:t.order,type:t.type,choice:t.choices,answerText:t.text,explanation:t.explanation,confidence:t.confidence,source:t.source}))}}}function be(n){if(!n)return "unknown";const t=String(n).toLowerCase();return /(single|单选)/.test(t)?"single":/(multiple|多选)/.test(t)?"multiple":/(true|false|判断)/.test(t)?"true_false":/(fill|填空)/.test(t)?"fill":/(short|简答|问答)/.test(t)?"short":"unknown"}function U(n){const e=(i=>typeof i=="string"?JSON.parse(i):i)(n),o=[],r=(i,a)=>{if(typeof i=="string"||Array.isArray(i)){const f=typeof a=="string"?parseInt(a,10):a,p=Array.isArray(i)?i.map(String):[String(i)];o.push({order:f,type:"unknown",choices:[],text:p});return}const c=Number(i.order??a),d=be(i.type),u=Array.isArray(i.choice)?i.choice.map(String):[],l=i.answerText==null?[]:Array.isArray(i.answerText)?i.answerText.map(String):[String(i.answerText)];o.push({order:c,type:d,choices:u,text:l,explanation:i.explanation,confidence:i.confidence,source:i.source});},s=e.answers;if(Array.isArray(s))for(const i of s)r(i);else if(s&&typeof s=="object")for(const[i,a]of Object.entries(s))r(a,i);return o.filter(i=>Number.isFinite(i.order))}const ge={version:"1.0",answers:[{order:1,type:"single",choice:["C"],explanation:"理由...",confidence:.93},{order:2,type:"multiple",choice:["A","D"],explanation:"理由...",confidence:.87},{order:3,type:"true_false",choice:["T"],explanation:"True 为正确，False 为错误"},{order:4,type:"fill",answerText:["第一空内容","第二空内容"]},{order:5,type:"short",answerText:["简答题作答要点 1","要点 2"]}],meta:{generator:"CJ-AI",ts:Date.now()}},pt="你是一个严谨的答题助手。根据我提供的“按顺序排列”的题目截图，输出 JSON 答案。",ft='\n要求：\n- 仅输出 JSON，请使用 ``` 包裹，不要解释或多余文本。\n- `order` 从 1 开始，按我提供的题目顺序递增。\n- 单选/多选：在 `choice` 字段中返回大写字母数组，例如 ["A"] 或 ["A","C"]。\n- 判断题：`choice` 使用 ["T"] 或 ["F"] 表示对/错。\n- 填空/简答：将文本答案拆分为数组，写入 `answerText`，每空或每行一个元素。\n- 如果无法确定题型，`type` 可为 "unknown"。\n- 可选：`explanation` 给出简要理由；`confidence` 给出 0~1 之间的置信度。\n',ht="You are a rigorous answering assistant. Given question screenshots in order, output answers as JSON.",mt='\nRules:\n- Output JSON only. No extra words.\n- `order` starts from 1 and follows the input order.\n- Single/Multiple choice: return uppercase letters in `choice`, e.g., ["A"] or ["A","C"].\n- True/False: use ["T"] or ["F"] in `choice`.\n- Fill-in/Short: split text into an array in `answerText`, one blank/line per item.\n- If unknown type, set `type` to "unknown".\n- Optional: `explanation` for brief rationale; `confidence` in [0,1].\n';function ye(n){return n==="zh"?`${pt}

${ft}`.trim():n==="en"?`${ht}

${mt}`.trim():`${pt}

${ft}

${ht}

${mt}`.trim()}function K(n={}){const t=n.lang??"zh",e=n.version??"1.0",o=n.includeExample??true,r=n.customExample??ge,s=(n.extraNotes??[]).map(l=>`- ${l}`).join(`
`),i=ye(t),a=t==="en"?"JSON Schema/Shape":"JSON 形状与字段说明",c=t==="en"?"Example":"示例",d=t==="en"?"Return JSON only":"仅输出 JSON",u=JSON.stringify(r,null,2);return [i,s&&(t==="en"?`Notes:
`:`注意：
`)+s,`${a} (version: ${e}):
{
  "version": "${e}",
  "answers": [
    {
      "order": 1,
      "type": "single | multiple | true_false | fill | short | unknown",
      "choice": ["A"],
      "answerText": ["string"],
      "explanation": "string",
      "confidence": 0.9,
      "source": "optional"
    }
  ]
}`,o?`${c} (DO NOT COPY LITERALLY):
\`\`\`
${u}
\`\`\``:"",`${d}.`].filter(Boolean).join(`

`)}const Q="CJAI_BRIDGE_V1";function It(n){return !!n&&n.data&&n.data.channel===Q&&typeof n.data.type=="string"}function xe(n,t){const e=new Map,o=r=>{if(!It(r))return;const s=e.get(r.data.type);if(s)for(const i of Array.from(s))try{i(r.data);}catch{}};return window.addEventListener("message",o),{role:"client",target:n,origin:t,send:(r,s)=>{n.postMessage({channel:Q,type:r,payload:s,from:location.origin},t);},on:(r,s)=>{let i=e.get(r);return i||(i=new Set,e.set(r,i)),i.add(s),()=>{i.delete(s);}},destroy:()=>window.removeEventListener("message",o)}}function we(n){const t=new Map,e=o=>{if(!It(o)||!n.includes("*")&&!n.includes(o.origin))return;const r=t.get(o.data.type),s=(i,a)=>{o.source&&o.source.postMessage({channel:Q,type:i,payload:a,from:location.origin},o.origin);};if(r)for(const i of Array.from(r))try{i(o.data,s);}catch{}};return window.addEventListener("message",e),{role:"host",on:(o,r)=>{let s=t.get(o);return s||(s=new Set,t.set(o,s)),s.add(r),()=>{s.delete(r);}},destroy:()=>window.removeEventListener("message",e)}}function ve(n,t="cjai-bridge",e="width=480,height=720"){try{return window.open(n,t,e)}catch{return null}}const Lt="https://www.doubao.com",Se="https://www.doubao.com/";function Ee(){if(!location.origin.startsWith(Lt))return;const e=we(["https://changjiang.yuketang.cn","https://changjiang-exam.yuketang.cn"]);e.on("ping",(o,r)=>{console.log("[CJAI bridge@doubao] ping from",o.from,"payload:",o.payload),r("pong",{ok:true,at:Date.now()});}),e.on("db.compose",async(o,r)=>{try{const s=o.payload||{},i=s.text,a=!!s.send,c=s.fileName||s.name,d=s.dataUrl||s.imageDataUrl,u=s.blob,l=await H(6e3);if(!l){r("db.result",{ok:!1,reason:"composer-not-found"});return}if(i&&i.length&&!_e(l,i)){r("db.result",{ok:!1,reason:"set-text-failed"});return}let f=!1;if(u||d){const p=u||await xt(d),b=new File([p],c||`image-${Date.now()}.png`,{type:p.type||"image/png"});f=await yt(l,b)||!1;}if(a){if(f)try{await Le(900);}catch{}const p=await gt(l);r("db.result",{ok:p,attached:f});return}r("db.result",{ok:!0,attached:f});}catch(s){r("db.result",{ok:false,reason:String(s)});}}),e.on("db.attachImage",async(o,r)=>{try{const s=o.payload||{},i=s.fileName||s.name||`image-${Date.now()}.png`,a=s.dataUrl,c=s.blob,d=await H(6e3);if(!d){r("db.result",{ok:!1,reason:"composer-not-found"});return}const u=c||await xt(a),l=new File([u],i,{type:u.type||"image/png"}),f=await yt(d,l);r("db.result",{ok:f});}catch(s){r("db.result",{ok:false,reason:String(s)});}}),e.on("db.send",async(o,r)=>{try{const s=await H(6e3);if(!s){r("db.result",{ok:!1,reason:"composer-not-found"});return}const i=await gt(s);r("db.result",{ok:i});}catch(s){r("db.result",{ok:false,reason:String(s)});}}),e.on("db.getLastJson",async(o,r)=>{try{const s=$e();s?r("db.lastJson",{ok:!0,text:s}):r("db.lastJson",{ok:!1,reason:"json-not-found"});}catch(s){r("db.lastJson",{ok:false,reason:String(s)});}}),h.info("Doubao host ready for CJ-AI bridge");}let k=null,C=null,M=null;function bt(){try{k&&!k.closed&&k.focus();}catch{}}function $(){if(k&&!k.closed&&C)return bt(),true;const n=ve(Se,"cjai-doubao","width=980,height=720");if(!n)return h.warn("Open Doubao popup failed"),false;if(k=n,C=xe(n,Lt),M){try{M();}catch{}M=null;}return M=C.on("pong",t=>{h.success("Doubao pong",t.payload);}),bt(),true}function Rt(){(!C||!k||k.closed)&&!$()||C.send("ping",{ts:Date.now()});}function J(n){if((!C||!k||k.closed)&&!$())return  false;try{return C.send("db.compose",n),!0}catch{return  false}}function ke(n,t=`image-${Date.now()}.png`){if((!C||!k||k.closed)&&!$())return  false;try{return C.send("db.attachImage",{blob:n,fileName:t}),!0}catch{return  false}}function Ce(){if((!C||!k||k.closed)&&!$())return  false;try{return C.send("db.send"),!0}catch{return  false}}function je(n){const t=n.trim();if(!t||t[0]!=="{"&&t[0]!=="[")return  false;try{return JSON.parse(t),!0}catch{return  false}}function X(n,t,e="question.png"){return je(n)?J({text:n,send:true}):J(t?{text:n,blob:t,fileName:e,send:true}:{text:n,send:true})}function Jt(n=8e3){return (!C||!k||k.closed)&&!$()?Promise.resolve({ok:false,reason:"no-bridge"}):new Promise(t=>{let e=false;const o=setTimeout(()=>{e||(r(),e=true,t({ok:false,reason:"timeout"}));},n),r=C.on("db.lastJson",s=>{if(e)return;e=true,r(),clearTimeout(o);const i=s.payload||{};t({ok:!!i.ok,text:i.text,reason:i.reason});});try{C.send("db.getLastJson");}catch{r(),clearTimeout(o),t({ok:false,reason:"send-failed"});}})}function D(n){if(!n||!(n instanceof HTMLElement))return  false;const t=n.getBoundingClientRect(),e=getComputedStyle(n);return !(e.visibility==="hidden"||e.display==="none"||e.opacity==="0"||t.width<=0||t.height<=0)}async function H(n=5e3){const t=Date.now();for(;Date.now()-t<n;){try{let s=Array.from(document.querySelectorAll("textarea")).filter(c=>D(c)&&!c.disabled).map(c=>({a:c,rect:c.getBoundingClientRect()})).sort((c,d)=>d.rect.top-c.rect.top)[0]?.a||null,i=null;s||(i=Array.from(document.querySelectorAll('[contenteditable="true"]')).filter(l=>D(l)).map(l=>({e:l,rect:l.getBoundingClientRect()})).sort((l,f)=>f.rect.top-l.rect.top)[0]?.e||null);const a=s||i;if(a&&D(a)){const c=Ae(a),d=Te(c);return {textarea:s||null,editable:s?null:i,container:c,sendBtn:d}}}catch{}await new Promise(e=>setTimeout(e,200));}return null}function Ae(n){let t=n;for(let e=0;e<6&&t?.parentElement;e++)t=t.parentElement;return t||document.body}function Ne(n){return (n.textContent||"").trim().replace(/\s+/g,"")}function Te(n){const t=Array.from(n.querySelectorAll("button"));let e=null;for(const o of t){if(!D(o)||o.disabled)continue;const r=o.getBoundingClientRect(),s=r.top*.001+r.right*5e-4,i=Ne(o)+" "+((o.getAttribute("aria-label")||"")+(o.getAttribute("title")||""));let a=0;/发送|Send/i.test(i)&&(a+=10),/发送/.test(i)&&(a+=5);const c=a+1/(1+s);(!e||c>e.score)&&(e={score:c,el:o});}return e?.el||null}function _e(n,t){try{if(n.textarea){const e=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value")?.set;return e?e.call(n.textarea,t):n.textarea.value=t,n.textarea.dispatchEvent(new Event("input",{bubbles:!0})),!0}return n.editable?(n.editable.focus(),n.editable.textContent=t,n.editable.dispatchEvent(new Event("input",{bubbles:!0})),!0):!1}catch{return  false}}async function gt(n){const t=n.textarea||n.editable;if(t)try{const e={key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0};return t.dispatchEvent(new KeyboardEvent("keydown",e)),t.dispatchEvent(new KeyboardEvent("keypress",e)),t.dispatchEvent(new KeyboardEvent("keyup",e)),!0}catch{}if(n.sendBtn)try{return n.sendBtn.click(),!0}catch{}return  false}async function yt(n,t){const e=n.container||n.textarea||n.editable||document.body;try{if(await De(e,t))return !0}catch{}try{const o=Oe(n.container);if(o&&await Ie(o,t))return o.dispatchEvent(new Event("change",{bubbles:!0})),!0}catch{}return  false}function Oe(n){const e=Array.from(n.querySelectorAll('input[type="file"]')).filter(r=>{const s=(r.accept||"").toLowerCase();return s.includes("image")||s.includes("png")||s.includes("jpg")||s.includes("jpeg")});return e.find(r=>D(r))||e[0]||null}async function De(n,t){if(!("DataTransfer"in window))return  false;try{const e=new DataTransfer;e.items.add(t);const o={bubbles:!0,cancelable:!0,dataTransfer:e};return n.dispatchEvent(new DragEvent("dragenter",o)),n.dispatchEvent(new DragEvent("dragover",o)),n.dispatchEvent(new DragEvent("drop",o))}catch{return  false}}async function Ie(n,t){try{const e=new DataTransfer;return e.items.add(t),n.files=e.files,!!n.files?.length}catch{return  false}}async function xt(n){const t=n.match(/^data:([^;]+);base64,(.*)$/);if(!t)return fetch(n).then(i=>i.blob());const e=t[2],o=atob(e),r=o.length,s=new Uint8Array(r);for(let i=0;i<r;i++)s[i]=o.charCodeAt(i);return new Blob([s],{type:t[1]||"application/octet-stream"})}function Le(n){return new Promise(t=>setTimeout(t,n))}function Re(){return Array.from(document.querySelectorAll('button[data-testid="message_action_copy"]')).filter(t=>D(t))}function Je(n){let t=n;for(let e=0;e<10&&t;e++){const o=t;if(o.querySelector("pre code, pre, code"))return o;t=o.parentElement;}t=n.parentElement;for(let e=0;e<4&&t?.parentElement;e++)t=t.parentElement;return t||null}function wt(n){const t=n.trim();let e=t;const o=t.match(/```(?:json)?\s*([\s\S]*?)```/i);if(o&&(e=o[1]),!(e.startsWith("{")||e.startsWith("[")))return null;try{const r=JSON.parse(e);return r&&(Array.isArray(r.answers)||r.answers),r}catch{return null}}function Pe(n){const t=[],e=Array.from(n.querySelectorAll("pre code"));for(const s of e)t.push(s.textContent||"");if(!t.length){const s=Array.from(n.querySelectorAll("pre"));for(const i of s)t.push(i.textContent||"");}if(!t.length){const s=Array.from(n.querySelectorAll("code"));for(const i of s)t.push(i.textContent||"");}for(const s of t){const i=wt(s);if(i)return typeof i=="string"?i:JSON.stringify(i)}const o=n.textContent||"",r=wt(o);return r?typeof r=="string"?r:JSON.stringify(r):null}function $e(){const n=Re();if(!n.length)return null;for(let t=n.length-1;t>=0;t--){const e=n[t],o=Je(e);if(!o)continue;const r=Pe(o);if(r)return r}return null}class qe{constructor(t){this.store=t;const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.height="100%",e.style.gap="8px";const o=document.createElement("div");o.style.display="flex",o.style.gap="8px",o.style.alignItems="center";const r=this.btn("Select All",()=>this.store.selectAll(true)),s=this.btn("Select None",()=>this.store.selectAll(false)),i=this.btn("Clear",()=>this.store.clear()),a=this.btn("Download Zip",()=>this.downloadZip()),c=this.btn("Save to Folder",()=>this.saveToDir()),d=this.btn("Download Files",()=>this.downloadSequential()),u=j("doubaoBridge")?this.btn("Send Selected → Doubao",()=>this.sendSelectedToDoubao()):null;o.append(r,s,a,c,d,...u?[u]:[],i);const l=document.createElement("div");l.style.display="grid",l.style.gridTemplateColumns="repeat(auto-fill, minmax(160px, 1fr))",l.style.gap="8px",l.style.overflow="auto",l.style.padding="2px",e.append(o,l),this.el=e,this.listEl=l,this.store.subscribe(()=>this.render()),this.render();}el;listEl;btn(t,e){const o=document.createElement("button");return o.textContent=t,o.className="cjai-btn",o.onclick=e,o}card(t){const e=document.createElement("div");e.style.border="1px solid var(--cjai-border)",e.style.borderRadius="8px",e.style.overflow="hidden",e.style.background="var(--cjai-bg)",e.style.display="flex",e.style.flexDirection="column",e.style.gap="6px",e.style.padding="6px";const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.style.gap="6px";const r=document.createElement("div");r.style.display="flex",r.style.gap="6px",r.style.alignItems="center";const s=document.createElement("input");s.type="checkbox",s.checked=t.selected,s.onchange=()=>this.store.setSelected(t.order,s.checked);const i=document.createElement("div");i.textContent=`#${t.order}`,r.append(s,i);const a=document.createElement("div");a.style.display="flex",a.style.gap="6px";const c=this.btn("Retry",()=>this.retry(t.order)),d=this.btn("Open",()=>{t.url&&window.open(t.url,"_blank");}),u=j("doubaoBridge")?this.btn("Send",()=>this.sendOneToDoubao(t)):null;a.append(c,d,...u?[u]:[]),o.append(r,a);const l=document.createElement("div");if(l.style.aspectRatio="4/3",l.style.overflow="hidden",l.style.background="rgba(0,0,0,0.03)",l.style.border="1px solid var(--cjai-border)",l.style.borderRadius="6px",t.url){const p=document.createElement("img");p.src=t.url,p.style.width="100%",p.style.height="100%",p.style.objectFit="contain",l.appendChild(p);}else l.textContent=t.status==="pending"?"Pending…":"No image",l.style.display="grid",l.style.placeItems="center";const f=document.createElement("div");return f.style.fontSize="12px",f.style.color="var(--cjai-ink-muted)",f.textContent=t.filename,e.append(o,l,f),e}buildImagePrompt(t){const e=[];return t!=null?e.push(`仅针对当前图片作答；请只返回一个 answers 项，并将 order 固定为 ${t}。`):e.push("仅针对当前图片作答；请只返回一个 answers 项。"),K({lang:"zh",includeExample:true,extraNotes:e})}async sendOneToDoubao(t){try{if(!t.blob){h.warn("No image to send");return}const e=this.buildImagePrompt(t.order);X(e,t.blob,t.filename||`question-${t.order}.png`)||h.warn("Send to Doubao failed to dispatch");}catch(e){h.error("Send one to Doubao failed",e);}}async sendSelectedToDoubao(){const t=this.store.selected();if(!t.length){h.warn("No selected captures");return}h.banner("Doubao",`Sending ${t.length} selected captures`);for(const e of t)await this.sendOneToDoubao(e),await G(1600);h.success("Queued sending to Doubao");}async retry(t){h.info("Retry capture",t);const e=new CustomEvent("cjai:retry",{detail:{order:t}});window.dispatchEvent(e);}selectedFiles(){return this.store.selected().map(t=>({name:t.filename,blob:t.blob}))}async downloadZip(){const t=this.selectedFiles();if(!t.length)return;await ie(t,"captures.zip")||h.warn("Zip not available, try other download method");}async saveToDir(){const t=this.selectedFiles();if(!t.length)return;await ce(t)||h.warn("Cannot save to directory (unsupported or denied)");}async downloadSequential(){const t=this.selectedFiles();t.length&&await ae(t);}render(){this.listEl.innerHTML="";for(const t of this.store.list())this.listEl.appendChild(this.card(t));}}function A(n){return (n?.textContent||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim()}function Me(){return document.querySelector(".container-problem .el-scrollbar__view")||document.querySelector(".container-problem")||document}function ze(){const n=Me(),t=Array.from(n.querySelectorAll(".subject-item"));t.length===0&&h.warn("No .subject-item found when extracting JSON");const e=[],o=new Set;for(let r=0;r<t.length;r++){const s=t[r],i=s.querySelector(".item-type"),a=A(i),c=/(\d+)\.(\S+)\s*\((\d+(?:\.\d+)?)分\)/.exec(a)||/(\d+)\s*[\.、]\s*(\S+).*?(\d+(?:\.\d+)?)\s*分/.exec(a),d=c?parseInt(c[1],10):r+1,u=c?c[2]:"",l=c?Math.round(parseFloat(c[3])*100)/100:0,p=s.querySelector(".status")?"已提交":"未提交",b=/填空/.test(a)||/填空/.test(u);let m="",E=0,w=[];if(b){const g=Be(s);m=g.question,E=g.blanks,w=g.answers;}else {const g=s.querySelector(".item-body h4");if(g){const v=g.querySelector(".custom_ueditor_cn_body");if(v){const S=v.querySelector("p");m=A(S||v);}else {const S=g.querySelector("p");m=A(S||g);}}else {const v=s.querySelector(".item-body .custom_ueditor_cn_body")||s.querySelector(".item-body");m=A(v);}}const y=[];s.querySelectorAll(".list-unstyled-radio li").forEach(g=>{const v=g.querySelector(".radioInput");let S=g.querySelector(".radioText .custom_ueditor_cn_body");if(S||(S=g.querySelector(".radioText")),!v||!S)return;const F=S.querySelector("p"),q=A(F||S),st=A(v);st&&y.push({key:st,value:q});}),s.querySelectorAll(".list-unstyled-checkbox li").forEach(g=>{const v=g.querySelector(".checkboxInput");let S=g.querySelector(".checkboxText .custom_ueditor_cn_body");if(S||(S=g.querySelector(".checkboxText")),!v||!S)return;const F=A(S),q=A(v);q&&y.push({key:q,value:F});}),s.querySelectorAll(".list-inline.list-unstyled-radio li").length===2&&y.length===0&&(y.push({key:"✓",value:"正确"}),y.push({key:"✗",value:"错误"}));let I=null;const tt=s.querySelector(".el-radio.is-checked");if(tt){const g=tt.querySelector(".radioInput");g&&(I=A(g));}const et=Array.from(s.querySelectorAll(".el-checkbox.is-checked"));if(et.length>0){I=[];for(const g of et){const v=g.querySelector(".checkboxInput"),S=A(v);S&&I.push(S);}}if(b){const g=w.map(v=>v.trim()).filter(v=>v.length>0);g.length>0&&(I=g);}const nt=m.trim()!==""&&u!==""&&l>0,ot=o.has(d);if(!nt||ot){h.debug("Skip item",{id:d,valid:nt,dup:ot,typeText:a});continue}o.add(d);const rt={id:d,type:u,score:l,status:p,question:m,options:y,selected:I,rawTypeText:a};b&&(rt.blanks=E),e.push(rt);}return h.success("Extracted questions",e.length),e}function Be(n){const t=n.querySelector(".item-body")||n,e=Array.from(t.querySelectorAll('input.blank-item-dynamic, input[type="text"].blank-item-dynamic, input.blank-item, input[type="text"]')),o=e.map(u=>(u.value||"").trim()),r=t.querySelector(".exam-font")||t.querySelector(".custom_ueditor_cn_body")||t;let s=0;const i=[],a=u=>{if(u.nodeType===Node.TEXT_NODE){const p=(u.textContent||"").replace(/\u00A0/g," ");i.push(p);return}if(!(u instanceof Element))return;const l=u;if(l.tagName.toLowerCase()==="input"&&l.type==="text"){s+=1,i.push(`【空${s}】`);return}const f=Array.from(l.childNodes);if(f.length!==0)for(const p of f)a(p);};a(r);let c=i.join("");c=c.replace(/\s+/g," ").replace(/\s([，。！？；,.!?])/g,"$1").trim();const d=Math.max(e.length,s);return {question:c,blanks:d,answers:o}}function Fe(n){try{return JSON.parse(n)}catch{return null}}function vt(n,t){try{return JSON.stringify(n,null,t?void 0:2)}catch{return String(n??"")}}function St(n,t={}){const e=t.lang??"zh",o=K({lang:e,includeExample:t.includeExample!==false,extraNotes:t.extraNotes}),r=typeof n=="string"?Fe(n)??n:n,s=typeof r=="string"?r:vt(r,t.minifyJson!==false),i=e==="en"?"Questions JSON (in order):":"按顺序排列的题目 JSON：",a=`${o}

${i}

\`\`\`json
${s}
\`\`\``;if(!t.maxChars||a.length<=t.maxChars)return a;const c=(()=>{if(typeof r=="string")return a;const u=vt(r,true);return `${o}

${i}

\`\`\`json
${u}
\`\`\``})();if(c.length<=(t.maxChars||0))return c;const d=s.slice(0,Math.max(0,(t.maxChars||0)-o.length-i.length-32))+`
/* clipped */`;return `${o}

${i}

\`\`\`json
${d}
\`\`\``}class He{el;textarea;btnScan;btnCopy;btnDownload;btnCopyPrompt;btnSendDoubao;langSelect;includeExample;minifyJson;status;constructor(){const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.height="100%",t.style.gap="8px";const e=document.createElement("div");e.style.display="flex",e.style.gap="8px",e.style.alignItems="center",e.style.border="1px solid var(--cjai-border)",e.style.borderRadius="8px",e.style.padding="6px";const o=document.createElement("button");o.className="cjai-btn cjai-btn--primary",o.textContent="Scan Page";const r=document.createElement("button");r.className="cjai-btn",r.textContent="Copy JSON";const s=document.createElement("button");s.className="cjai-btn",s.textContent="Download";const i=document.createElement("button");i.className="cjai-btn",i.textContent="Copy Prompt";const a=document.createElement("button");a.className="cjai-btn",a.textContent="Send to Doubao";const c=document.createElement("select");c.className="cjai-btn";const d=document.createElement("option");d.value="zh",d.textContent="中文";const u=document.createElement("option");u.value="en",u.textContent="English";const l=document.createElement("option");l.value="zh-en",l.textContent="中英",c.append(d,u,l),c.value="zh";const f=document.createElement("label");f.style.display="inline-flex",f.style.alignItems="center",f.style.gap="4px";const p=document.createElement("input");p.type="checkbox",p.checked=true;const b=document.createElement("span");b.textContent="Example",f.append(p,b);const m=document.createElement("label");m.style.display="inline-flex",m.style.alignItems="center",m.style.gap="4px";const E=document.createElement("input");E.type="checkbox",E.checked=true;const w=document.createElement("span");w.textContent="Minify",m.append(E,w);const y=document.createElement("div");y.style.marginLeft="auto",y.style.fontSize="12px",y.style.color="var(--cjai-ink-muted)",e.append(o,r,s,i,a,c,f,m,y);const N=document.createElement("textarea");N.style.flex="1",N.style.width="100%",N.style.resize="none",N.style.border="1px solid var(--cjai-border)",N.style.borderRadius="8px",N.style.padding="8px",t.append(e,N),this.el=t,this.textarea=N,this.btnScan=o,this.btnCopy=r,this.btnDownload=s,this.btnCopyPrompt=i,this.btnSendDoubao=a,this.langSelect=c,this.includeExample=p,this.minifyJson=E,this.status=y,this.btnScan.onclick=()=>this.scan(),this.btnCopy.onclick=()=>this.copy(),this.btnDownload.onclick=()=>this.download(),this.btnCopyPrompt.onclick=()=>this.copyPrompt(),this.btnSendDoubao.onclick=()=>this.sendToDoubao();}setStatus(t,e=true){this.status.textContent=t,this.status.style.color=e?"var(--cjai-ink-muted)":"#e11d48";}update(t){this.textarea.value=t;}scan(){try{const t=ze();if(!t.length){this.setStatus("No questions found",!1);return}const e=JSON.stringify(t,null,2);this.update(e),this.setStatus(`Extracted ${t.length} questions`);}catch(t){h.error("Scan failed",t),this.setStatus("Scan failed",false);}}async copy(){try{await navigator.clipboard.writeText(this.textarea.value),this.setStatus("Copied");}catch{this.setStatus("Copy failed",false);}}download(){try{const t=new Blob([this.textarea.value||"[]"],{type:"application/json"}),e=URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download="questions.json",document.body.appendChild(o),o.click(),o.remove(),setTimeout(()=>URL.revokeObjectURL(e),8e3),this.setStatus("Downloaded");}catch{this.setStatus("Download failed",false);}}async copyPrompt(){const t=this.textarea.value.trim();if(!t){this.setStatus("No JSON",false);return}try{const e=St(t,{lang:this.langSelect.value,includeExample:this.includeExample.checked,minifyJson:this.minifyJson.checked,extraNotes:["请严格依题目顺序（order 从 1 开始）。","如题目为填空题，按空序填写 answerText 数组。"]});await navigator.clipboard.writeText(e),this.setStatus("Prompt copied");}catch(e){h.error("Copy prompt failed",e),this.setStatus("Copy prompt failed",false);}}async sendToDoubao(){const t=this.textarea.value.trim();if(!t){this.setStatus("No JSON",false);return}try{const e=St(t,{lang:this.langSelect.value,includeExample:this.includeExample.checked,minifyJson:this.minifyJson.checked,extraNotes:["请严格依题目顺序（order 从 1 开始）。","如题目为填空题，按空序填写 answerText 数组。"]});if(!X(e)){this.setStatus("Bridge not ready",!1);return}this.setStatus("Sent to Doubao"),setTimeout(async()=>{try{const r=await Jt(2e4);if(!r.ok||!r.text){this.setStatus("No AI JSON yet");return}const s=window.CJAI?.importAnswers?.(r.text)??0;this.setStatus(`Imported ${s} answers`);}catch(r){h.error("Auto import from Doubao failed",r),this.setStatus("Auto import failed",!1);}},5e3);}catch(e){h.error("Send to Doubao failed",e),this.setStatus("Send failed",false);}}}class We{constructor(t){this.store=t;const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.height="100%",e.style.gap="8px";const o=document.createElement("div");o.style.display="flex",o.style.gap="8px",o.style.alignItems="center",o.style.border="1px solid var(--cjai-border)",o.style.borderRadius="8px",o.style.padding="6px";const r=document.createElement("button");r.className="cjai-btn cjai-btn--primary",r.textContent="Copy Prompt";const s=document.createElement("button");s.className="cjai-btn",s.textContent="Parse JSON";const i=document.createElement("button");i.className="cjai-btn",i.textContent="Pull Doubao";const a=document.createElement("select");a.className="cjai-btn";const c=document.createElement("option");c.value="zh",c.textContent="中文";const d=document.createElement("option");d.value="en",d.textContent="English";const u=document.createElement("option");u.value="zh-en",u.textContent="中英",a.append(c,d,u),a.value="zh";const l=document.createElement("label");l.style.display="inline-flex",l.style.alignItems="center",l.style.gap="4px";const f=document.createElement("input");f.type="checkbox",f.checked=true;const p=document.createElement("span");p.textContent="Example",l.append(f,p);const b=document.createElement("div");b.style.marginLeft="auto",b.style.fontSize="12px",b.style.color="var(--cjai-ink-muted)";const m=document.createElement("button");m.className="cjai-btn",m.textContent="Hide Input",o.append(r,a,l,s,i,m,b);const E=document.createElement("div");E.style.display="block";const w=document.createElement("textarea");w.placeholder="粘贴答题器输出的 JSON（见示例格式）",w.style.width="100%",w.style.height="120px",w.style.border="1px solid var(--cjai-border)",w.style.borderRadius="8px",w.style.padding="8px",w.spellcheck=false,E.appendChild(w);const y=document.createElement("div");y.style.flex="1",y.style.overflow="auto",y.style.border="1px solid var(--cjai-border)",y.style.borderRadius="8px",y.style.padding="8px",e.append(o,E,y),this.el=e,this.input=w,this.btnParse=s,this.btnPrompt=r,this.langSelect=a,this.includeExample=f,this.list=y,this.status=b,this.btnToggleInput=m,this.inputWrap=E,this.btnPullDoubao=i,this.btnParse.onclick=()=>this.parse(),this.btnPrompt.onclick=()=>this.copyPrompt(),this.btnPullDoubao.onclick=()=>this.pullDoubao(),this.btnToggleInput.onclick=()=>this.setInputCollapsed(!this.collapsed),this.store.subscribe(()=>this.render()),this.render();}el;input;btnParse;btnPrompt;langSelect;includeExample;list;status;btnToggleInput;inputWrap;collapsed=false;highlightedOrder=null;btnPullDoubao;setStatus(t,e=true){this.status.textContent=t,this.status.style.color=e?"var(--cjai-ink-muted)":"#e11d48";}setInputText(t){this.input.value=t;}async copy(t){try{await navigator.clipboard.writeText(t),this.setStatus("Copied");}catch{this.setStatus("Copy failed",false);}}async copyPrompt(){const t={lang:this.langSelect.value??"zh",includeExample:this.includeExample.checked},e=K(t);await this.copy(e);}async pullDoubao(){try{this.setStatus("Pulling from Doubao…");const t=await Jt(12e3);if(!t.ok||!t.text){this.setStatus(t.reason||"No JSON found",!1);return}this.setInputText(t.text);try{const e=U(t.text);for(const o of e)this.store.upsert(o);this.afterParseSuccess(e.length),this.setStatus("Imported from Doubao");}catch(e){h.error("Normalize answers failed",e),this.setStatus("JSON parse error",!1);}}catch(t){h.error("Pull Doubao failed",t),this.setStatus("Pull failed",false);}}setInputCollapsed(t){this.collapsed=t,this.inputWrap.style.display=t?"none":"block",this.btnToggleInput.textContent=t?"Show Input":"Hide Input";}setCurrentOrder(t){this.highlightedOrder=t??null;for(const e of Array.from(this.list.querySelectorAll("[data-order]"))){const o=Number(e.dataset.order);e.style.background=this.highlightedOrder===o?"rgba(17, 17, 17, 0.06)":"transparent",e.style.borderRadius="6px";}t!=null&&this.scrollToOrder(t);}scrollToOrder(t){const e=this.list.querySelector(`[data-order="${t}"]`);if(!e)return;const r=this.list.getBoundingClientRect(),s=e.getBoundingClientRect();(s.top<r.top||s.bottom>r.bottom)&&e.scrollIntoView({block:"center"});}badge(t){const e=document.createElement("span");return e.textContent=t,e.style.fontSize="11px",e.style.border="1px solid var(--cjai-border)",e.style.padding="2px 6px",e.style.borderRadius="999px",e.style.marginLeft="6px",e.style.color="var(--cjai-ink-muted)",e}render(){this.list.innerHTML="";const t=this.store.list();if(!t.length){const e=document.createElement("div");e.textContent="暂无答案，请粘贴 JSON 并解析",this.list.appendChild(e);return}for(const e of t){const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.gap="4px",o.style.padding="8px 6px",o.style.borderBottom="1px dashed var(--cjai-border)",o.dataset.order=String(e.order);const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="6px";const s=document.createElement("div");s.textContent=`#${e.order}`,s.style.fontWeight="600";const i=this.badge(e.type);e.confidence!=null?r.append(s,i,this.badge(`${Math.round(e.confidence*100)}%`)):r.append(s,i);const a=document.createElement("div");a.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Consolas, monospace",e.choices.length?a.textContent=`Choice: ${e.choices.join(", ")}`:e.text.length?a.textContent=`Text: ${e.text.join(" | ")}`:a.textContent="(empty)";const c=document.createElement("div");c.style.whiteSpace="pre-wrap",c.style.color="var(--cjai-ink-muted)",c.textContent=e.explanation||"",o.append(r,a,c),this.list.appendChild(o);}this.highlightedOrder!=null&&this.setCurrentOrder(this.highlightedOrder);}afterParseSuccess(t){this.setStatus(`Parsed ${t} answers`),this.setInputCollapsed(true);}parse(){const t=this.input.value.trim();if(!t){this.setStatus("No input");return}try{const e=U(t);this.store.setAll(e),this.afterParseSuccess(e.length);}catch(e){h.error("Parse notepad JSON failed",e),this.setStatus("JSON parse error",false);}}}var Et=typeof GM_info<"u"?GM_info:void 0;function kt(n,t){return (n.textContent||"").replace(/\s+/g," ").trim().includes(t)}function Ue(){const t=P().selectors?.submitButton,e=t?document.querySelector(t):null;if(e)return e;const o=document.querySelector(".container-problem .problem-fixedbar")||document.querySelector(".problem-fixedbar");if(o){const s=Array.from(o.querySelectorAll("button")),i=s.find(c=>kt(c,"提交"));if(i)return i;const a=s.find(c=>c.className.includes("el-button--primary"));if(a)return a}const r=Array.from(document.querySelectorAll("button")).find(s=>kt(s,"提交"));return r||null}function Ze(){const n=Ue();if(!n)return h.warn("Submit button not found"),false;try{return n.focus(),n.click(),h.success("Triggered submit"),!0}catch(t){return h.error("Submit click failed",t),false}}const Ct="CJ_AI_FLAGS_";function Ve(n){const t=document.createElement("label");t.className="cjai-switch";const e=document.createElement("input");e.type="checkbox",e.checked=n;const o=document.createElement("span");return o.className="cjai-switch__slider",t.append(e,o),{el:t,input:e}}class Ge{el;toggles=new Map;base=Tt();eff=P();status;constructor(){const t=document.createElement("div");t.className="cjai-section";const e=document.createElement("div");e.className="cjai-section__title",e.textContent="Feature Flags | 特性开关";const o=document.createElement("div");o.className="cjai-section__description",o.textContent="启用或禁用实验性功能，一般情况下并不需要修改此设置，功能会随着作用域自动更新。";const r=document.createElement("div");r.style.fontSize="12px",r.style.color="var(--cjai-ink-muted)",r.textContent=`Domain: ${this.base.domain}  •  Host: ${location.hostname}`;const s=document.createElement("div");s.className="cjai-rows";for(const[l,f]of Object.entries(this.eff.flags)){const p=document.createElement("div");p.className="cjai-row";const b=document.createElement("div");b.className="cjai-row__label",b.textContent=l;const m=Ve(!!f);p.append(b,m.el),s.appendChild(p),this.toggles.set(l,m.input);}const i=document.createElement("div");i.style.display="flex",i.style.gap="8px",i.style.marginTop="8px";const a=document.createElement("button");a.className="cjai-btn cjai-btn--primary",a.textContent="Apply";const c=document.createElement("button");c.className="cjai-btn",c.textContent="Reset";const d=document.createElement("button");d.className="cjai-btn",d.textContent="Reload";const u=document.createElement("div");u.style.marginLeft="auto",u.style.fontSize="12px",u.style.color="var(--cjai-ink-muted)",i.append(a,c,d,u),t.append(e,o,r,s,i),this.el=t,this.status=u,a.onclick=()=>this.apply(),c.onclick=()=>this.reset(),d.onclick=()=>location.reload();}setStatus(t,e=true){this.status.textContent=t,this.status.style.color=e?"var(--cjai-ink-muted)":"#e11d48";}apply(){try{const t=this.base.flags,e={};let o=!1;for(const[s,i]of this.toggles.entries()){const a=!!i.checked;e[s]=a,t[s]!==a&&(o=!0);}const r=`${Ct}${this.base.domain}`;o?(localStorage.setItem(r,JSON.stringify({flags:e})),this.setStatus("Overrides saved. Reload to take effect.")):(localStorage.removeItem(r),this.setStatus("No changes (overrides cleared)"));}catch(t){h.error("Apply flags failed",t),this.setStatus("Apply failed",false);}}reset(){try{const t=`${Ct}${this.base.domain}`;localStorage.removeItem(t);for(const[e,o]of this.toggles.entries())o.checked=!!this.base.flags[e];this.setStatus("Overrides cleared");}catch(t){h.error("Reset flags failed",t),this.setStatus("Reset failed",false);}}}const Ke=P(),Y=new he,Z=new me,R=new de({delayAfterNavigateMs:200,screenshot:{scale:Math.max(2,window.devicePixelRatio||1),backgroundColor:"#fff"},onCapture:n=>Y.upsert(n)}),V={nav:x,waitForQuestionElement:_t,runner:R,start:()=>R.captureAllFromCurrent(),stop:()=>R.stop(),one:n=>R.captureOne(n),store:Y,answers:Z,importAnswers:n=>{const t=U(n);return Z.setAll(t),t.length},features:Ke,doubao:{ping:()=>Rt(),compose:n=>J(n),attach:(n,t)=>ke(n,t),send:()=>Ce(),sendPrompt:(n,t)=>X(n,t)}};window.CJAI=V;h.banner("Injected","CJ-AI ready");h.info("Use in console:","CJAI.start()","CJAI.stop()","CJAI.one(n)");Ee();if(j("actionPanel")){const n=new fe({id:"cjai-panel",title:"CJ Capture",dock:"bottom-right"});{const o=document.createElement("div"),r=document.createElement("div");r.className="cjai-section";const s=document.createElement("div");s.className="cjai-section__title",s.textContent="About";const i=document.createElement("div");i.className="cjai-doc",i.textContent=`CJ Capture — 简易用法
作者: wibus
版本: ${Et.script.version}
命名空间: ${Et.script.namespace}
• 面板位于右下角，可拖拽、缩放、折叠。
• Tabs 说明：
  - Preview（截图预览，测试页面专属）：点击 Start 从“当前题”至“最后一题”依次截图；可在列表中勾选后 Download Zip / Save to Folder / Download Files；Retry 可重拍某题。
  - Extract（题目提取，考试页面专属）：Scan Page 获取题目 JSON；Copy Prompt 生成给 AI 的提示词（内含题目 JSON）；Download 保存 JSON 文件。
  - Notepad（答案簿）：将返回的 AnswerDoc JSON 粘贴→Parse JSON；列表按题号展示，跟随左侧导航自动滚动；输入区可 Hide/Show；Copy Prompt 可复制标准提示词模板。
• 快捷键：Cmd/Ctrl + G 触发页面提交按钮（如适配）。
• Feature Flags：Info 面板下方可切换功能开关；Apply 后 Reload 生效。一般来说，并不需要修改这些设置，功能会随着作用域自动更新。

• 未来：自动查看课程视频能力、更多题型支持
`,r.append(s,i);const a=new Ge;o.append(r,a.el),n.setDoc(o);}if(n.clearActions(),j("capture")&&(n.addAction({id:"start",label:"Start",kind:"primary",tooltip:"Capture all from current",hotkey:"S",onClick:()=>V.start()}),n.addAction({id:"stop",label:"Stop",kind:"danger",tooltip:"Stop capture",hotkey:"X",onClick:()=>V.stop()})),j("orderNav")&&(n.addAction({id:"prev",label:"Prev",tooltip:"Go to previous",hotkey:"A",onClick:()=>{x.prev();}}),n.addAction({id:"next",label:"Next",tooltip:"Go to next",hotkey:"D",onClick:()=>{x.next();}})),j("doubaoBridge")&&(n.addAction({id:"db-connect",label:"Doubao: Ping",tooltip:"Open Doubao (reuse) and send ping",onClick:()=>{Rt();}}),n.addAction({id:"db-send-test",label:"Doubao: Send Test",tooltip:"Compose test text and send",onClick:()=>{J({text:"Hello from CJ-AI bridge at "+new Date().toLocaleTimeString(),send:true});}})),j("capture")){const o=n.addTab({id:"preview",label:"Preview"}),r=new qe(Y);o.appendChild(r.el);}const t=n.addTab({id:"notepad",label:"Notepad"}),e=new We(Z);if(t.appendChild(e.el),j("questionExport")){const o=n.addTab({id:"extract",label:"Extract"}),r=new He;o.appendChild(r.el);}if(j("orderNav")){let o=null;setInterval(()=>{try{const r=x.current();r&&r!==o&&(o=r,e.setCurrentOrder(r));}catch{}},600);}}j("capture")&&window.addEventListener("cjai:retry",n=>{const t=Number(n?.detail?.order);t&&R.captureOne(t);});j("submitHotkey")&&window.addEventListener("keydown",n=>{const t=n.metaKey,e=n.ctrlKey;(t||e)&&!n.shiftKey&&!n.altKey&&n.key?.toLowerCase()==="e"&&(n.preventDefault(),Ze());});

})();